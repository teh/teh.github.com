<!DOCTYPE html>
<html><meta charset="utf-8"><meta name="generator" content="Hugo 0.62.0" /><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="color-scheme" content="light dark">
<meta name="supported-color-schemes" content="light dark"><title>Load balancing via iptables&nbsp;&ndash;&nbsp;Tom Stuff</title><link rel="stylesheet" href="/css/core.min.b36455a448f1b345e1de7ecfba4ebc7a459dc7297b9400f493511ce22e4017ae72a67d75b91ce89a5f95968e77e1380d.css" integrity="sha384-s2RVpEjxs0Xh3n7Puk68ekWdxyl7lAD0k1Ec4i5AF65ypn11uRzoml&#43;Vlo534TgN"><body>
    <div class="base-body max-width"><section id="header" class="header max-body-width">
    <div class="header-wrap">
        <div class="header-left-side"><a class="home" href="/"><span class="site-name">Tom Stuff</span><span class="site-slogan"> - The pay's not great, but the work is hard</span></a></div>
        <div class="header-right-side"></div>
    </div>
</section><div id="content" class="flex-body max-body-width"><section class="article-header">
    <h1>Load balancing via iptables</h1><p class="article-date">2012-03-09</p></section>
<article class="markdown-body"><p>Traditionally balancing between web workers has been implemented with a prefork server. I.e. the controlling process opens a socket, forks a few workers who then <code>accept</code> on that socket. The kernel will distribute the load accordingly.</p>
<p>Another way to implement this is to use iptablesâ€˜ connection tracking. It has the advantage that web workers can be started and shut down independently. It is also trivial to distribute the load via weigths. The following redirects 10% of the connections to port 9000 to port 9002, and 90% to port 9001.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="cp">#!/bin/sh
</span><span class="cp"></span>
sudo iptables -t mangle -F
sudo iptables -t nat -F
sudo iptables -F

sudo iptables -t nat -A OUTPUT -p tcp -j CONNMARK --set-mark <span class="m">43</span>
sudo iptables -t nat -A OUTPUT -p tcp -m statistic --mode random --probability 0.1 -j CONNMARK --set-mark <span class="m">42</span>

sudo iptables -t nat -A OUTPUT -p tcp --dport <span class="m">9000</span> -m connmark --mark <span class="m">42</span> -j DNAT --persistent --to 192.168.1.71:9001
sudo iptables -t nat -A OUTPUT -p tcp --dport <span class="m">9000</span> -m connmark --mark <span class="m">43</span> -j DNAT --persistent --to 192.168.1.71:9002
</code></pre></div><p>This enables you to start a new, experimental worker and redirect only a fraction of all traffic to it to see how it behaves. If everything is fine you can ramp up the traffic in steps until it serves all requests. You can then disable the old worker.</p></article><section class="article-labels"><a class="article-tag li" href=/tags/devops/><span class="hashtag">#</span>Devops</a></section><section class="article-navigation"><p><a class="link" href="/posts/stuff-i-learned-2/"><span class="li"></span>Stuff I learned - 2</a></p><p><a class="link" href="/posts/stuff-i-learned-1/"><span class="li"></span>Stuff I learned - 1</a class="link">
    </p></section></div><section id="footer" class="footer max-body-width"><p>Tom Stuff</p>
<p><span>Powered by </span><a href="https://gohugo.io">Hugo</a><span> and the </span><a href="https://themes.gohugo.io/hugo-notepadium/">Notepadium</a></p></section></div>
</body>

</html>